<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backend API Test - Browser</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 2px solid #f0f0f0;
        border-radius: 10px;
        background: #fafafa;
      }
      .test-section h3 {
        color: #555;
        margin-top: 0;
      }
      input,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: opacity 0.3s ease;
      }
      button:hover {
        opacity: 0.9;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status-check {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ AuraX Backend API Test</h1>

      <!-- Server Status Check -->
      <div class="test-section">
        <h3>1. Server Status Check</h3>
        <button onclick="checkServerStatus()">Check Server Status</button>
        <div
          id="statusResult"
          class="result status-check"
          style="display: none"
        ></div>
      </div>

      <!-- User Registration Test -->
      <div class="test-section">
        <h3>2. User Registration Test</h3>
        <input
          type="text"
          id="regUsername"
          placeholder="Username (e.g., testuser2024)"
          value="testuser2024"
        />
        <input
          type="email"
          id="regEmail"
          placeholder="Your actual email address"
          value=""
        />
        <input
          type="password"
          id="regPassword"
          placeholder="Password (e.g., TestPassword123!)"
          value="TestPassword123!"
        />
        <select id="regRole">
          <option value="creator">Creator</option>
          <option value="brand">Brand</option>
        </select>
        <button onclick="testRegistration()">Test Registration</button>
        <div id="regResult" class="result" style="display: none"></div>
      </div>

      <!-- Resend Verification Test -->
      <div class="test-section">
        <h3>3. Resend Verification Test</h3>
        <input
          type="email"
          id="resendEmail"
          placeholder="Email to resend verification to"
          value=""
        />
        <button onclick="testResendVerification()">
          Test Resend Verification
        </button>
        <div id="resendResult" class="result" style="display: none"></div>
      </div>

      <!-- Email Verification Test -->
      <div class="test-section">
        <h3>4. Email Verification Test</h3>
        <input
          type="email"
          id="verifyEmail"
          placeholder="Email address"
          value=""
        />
        <input
          type="text"
          id="verifyCode"
          placeholder="6-digit verification code"
          maxlength="6"
          value=""
        />
        <button onclick="testEmailVerification()">Verify Email</button>
        <div id="verifyResult" class="result" style="display: none"></div>
      </div>

      <!-- Login Test -->
      <div class="test-section">
        <h3>5. Login Test</h3>
        <input
          type="text"
          id="loginEmail"
          placeholder="Email or Username"
          value=""
        />
        <input
          type="password"
          id="loginPassword"
          placeholder="Password"
          value="TestPassword123!"
        />
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult" class="result" style="display: none"></div>
      </div>

      <!-- Instructions -->
      <div class="test-section">
        <h3>üìã Instructions & Improved Flow</h3>
        <p>
          <strong>Important:</strong> Make sure to use your real email address
          in the registration test so you can receive the verification code!
        </p>
        <p>
          <strong>Backend Server:</strong> Should be running on
          http://localhost:5002
        </p>

        <div class="instructions">
          <strong>üîÑ NEW: Smart Verification Flow</strong>
          <p>The system now intelligently handles unverified accounts:</p>
          <ul>
            <li>
              <strong>First Registration:</strong> Creates account and sends
              verification code
            </li>
            <li>
              <strong>Re-registration (Unverified):</strong> Updates account
              info and sends new code
            </li>
            <li>
              <strong>Re-registration (Verified):</strong> Suggests login
              instead
            </li>
            <li>
              <strong>Resend Always Works:</strong> For any unverified account
            </li>
          </ul>
        </div>

        <p><strong>Test Scenarios:</strong></p>
        <ol>
          <li>Check server status first</li>
          <li>Register with your real email</li>
          <li>
            <strong>NEW:</strong> Try registering again with same email (should
            send new code)
          </li>
          <li>Check your email/spam folder for verification code</li>
          <li>
            <strong>NEW:</strong> Enter the 6-digit code in verification section
          </li>
          <li>Test resend verification functionality if needed</li>
          <li>Try login (should work after email is verified)</li>
        </ol>

        <div class="warning">
          <strong>‚ö†Ô∏è Email Delivery:</strong> Verification codes are being sent
          successfully but may land in your <strong>Spam/Junk folder</strong>.
          Check there first!
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5002/api";

      async function makeRequest(url, method = "GET", data = null) {
        try {
          const options = {
            method,
            headers: {
              "Content-Type": "application/json",
            },
          };

          if (data) {
            options.body = JSON.stringify(data);
          }

          const response = await fetch(url, options);
          const result = await response.json();

          return {
            success: response.ok,
            status: response.status,
            data: result,
          };
        } catch (error) {
          return {
            success: false,
            error: error.message,
          };
        }
      }

      function showResult(elementId, result, isSuccess = null) {
        const element = document.getElementById(elementId);
        element.style.display = "block";

        let className = "info";
        if (isSuccess === true) className = "success";
        if (isSuccess === false) className = "error";
        if (result.success === false) className = "error";
        if (result.success === true) className = "success";

        element.className = `result ${className}`;

        // Show special message if available
        let displayText = "";
        if (result.specialMessage) {
          displayText =
            result.specialMessage + "\n\n" + JSON.stringify(result, null, 2);
        } else {
          displayText = JSON.stringify(result, null, 2);
        }

        element.textContent = displayText;
      }

      async function checkServerStatus() {
        showResult("statusResult", { message: "Checking server status..." });

        const result = await makeRequest("http://localhost:5002/");
        showResult("statusResult", result);
      }

      async function testRegistration() {
        const username = document.getElementById("regUsername").value;
        const email = document.getElementById("regEmail").value;
        const password = document.getElementById("regPassword").value;
        const role = document.getElementById("regRole").value;

        if (!email) {
          showResult(
            "regResult",
            { error: "Please enter your email address!" },
            false
          );
          return;
        }

        showResult("regResult", { message: "Sending registration request..." });

        const data = { username, email, password, role };
        const result = await makeRequest(
          `${API_BASE}/auth/register`,
          "POST",
          data
        );

        // Handle special cases for better UX
        if (result.data && result.data.isExistingAccount) {
          showResult(
            "regResult",
            {
              ...result,
              specialMessage:
                "üîÑ ACCOUNT FOUND: This email already has an unverified account. We've sent a new verification code!",
            },
            true
          );
        } else if (result.data && result.data.canLogin) {
          showResult(
            "regResult",
            {
              ...result,
              specialMessage:
                "‚úÖ ACCOUNT EXISTS: This email is already verified. Please use the login section below.",
            },
            false
          );
        } else {
          showResult("regResult", result);
        }

        // Auto-fill other forms with this email
        document.getElementById("resendEmail").value = email;
        document.getElementById("verifyEmail").value = email;
        document.getElementById("loginEmail").value = email;
      }

      async function testResendVerification() {
        const email = document.getElementById("resendEmail").value;

        if (!email) {
          showResult(
            "resendResult",
            { error: "Please enter an email address!" },
            false
          );
          return;
        }

        showResult("resendResult", {
          message: "Sending resend verification request...",
        });

        const data = { email };
        const result = await makeRequest(
          `${API_BASE}/auth/resend-verification`,
          "POST",
          data
        );

        showResult("resendResult", result);
      }

      async function testEmailVerification() {
        const email = document.getElementById("verifyEmail").value;
        const code = document.getElementById("verifyCode").value;

        if (!email || !code) {
          showResult(
            "verifyResult",
            { error: "Please enter both email and verification code!" },
            false
          );
          return;
        }

        if (code.length !== 6) {
          showResult(
            "verifyResult",
            { error: "Verification code must be exactly 6 digits!" },
            false
          );
          return;
        }

        showResult("verifyResult", { message: "Verifying email..." });

        const data = { email, code };
        const result = await makeRequest(
          `${API_BASE}/auth/verify-email`,
          "POST",
          data
        );

        showResult("verifyResult", result);

        // If verification successful, update login form
        if (result.success) {
          document.getElementById("loginEmail").value = email;
        }
      }

      async function testLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          showResult(
            "loginResult",
            { error: "Please enter both email and password!" },
            false
          );
          return;
        }

        showResult("loginResult", { message: "Sending login request..." });

        const data = { email, password };
        const result = await makeRequest(
          `${API_BASE}/auth/login`,
          "POST",
          data
        );

        showResult("loginResult", result);
      }

      // Auto-check server status on page load
      window.onload = function () {
        setTimeout(checkServerStatus, 1000);
      };
    </script>
  </body>
</html>
